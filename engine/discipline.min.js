import{getDateKey}from"../utils/helpers.js";export function updateDisciplineState(){const dateKey=getDateKey(this.state.selectedDate);const tasks=this.scheduleEngine.getScheduleForDate(this.state.selectedDate);let completedCount=0;let totalCount=0;tasks.forEach((task)=>{if(!task.optional){totalCount++;if(this.state.completedTasks[dateKey]?.[task.id]){completedCount++;}}});const completionRate=totalCount>0?(completedCount/totalCount)*100:0;const threshold=this.state.settings.punishmentThreshold;let newState="active";if(completionRate<threshold){newState="warning";}
if(completionRate<threshold/2){newState="failure";}
if(this.state.failedTasks[dateKey]){const failureCount=Object.keys(this.state.failedTasks[dateKey]).length;if(failureCount>0){newState="warning";}
if(failureCount>2){newState="failure";}
this.elements.failureCount.textContent=failureCount;}
if(newState!==this.state.disciplineState){this.state.disciplineState=newState;document.body.setAttribute("data-discipline-state",newState);if(newState==="warning"){this.showNotification("Discipline warning. Course correction required.","warning");}else if(newState==="failure"){this.showNotification("System failure. Mandatory reflection required.","danger");}}
const consistency=this.calculateConsistencyRate();this.state.analytics.consistencyRate=consistency;this.elements.consistencyRate.textContent=`${Math.round(consistency)}%`;this.updateCognitiveLoad();}
export function calculateConsistencyRate(){let consistentDays=0;let totalDays=0;for(let i=0;i<30;i++){const date=new Date();date.setDate(date.getDate()-i);const key=getDateKey(date);if(this.state.scores.dailyHistory?.[key]){totalDays++;const score=this.state.scores.dailyHistory[key];const dayOfWeek=date.getDay();const tasks=this.scheduleEngine.getScheduleForDate(date);let possible=0;tasks.forEach((task)=>{if(!task.optional){const baseXP=task.baseXP||10;const difficulty=task.difficulty||1.0;possible+=Math.round(baseXP*difficulty);}});if(score>=possible*0.7){consistentDays++;}}}
return totalDays>0?(consistentDays/totalDays)*100:0;}
export function updateCognitiveLoad(){const dateKey=getDateKey(this.state.selectedDate);const tasks=this.scheduleEngine.getScheduleForDate(this.state.selectedDate);let loadScore=0;let taskCount=0;tasks.forEach((task)=>{if(!task.optional){taskCount++;loadScore+=task.difficulty||1.0;if(this.state.completedTasks[dateKey]?.[task.id]){loadScore-=0.5;}else if(this.state.failedTasks[dateKey]?.[task.id]){loadScore+=0.3;}}});if(this.state.emergencyTasks[dateKey]){this.state.emergencyTasks[dateKey].forEach((task)=>{taskCount++;loadScore+=1.5;});}
let loadLevel="LOW";if(loadScore/taskCount>1.2)loadLevel="MEDIUM";if(loadScore/taskCount>1.5)loadLevel="HIGH";if(loadScore/taskCount>2.0)loadLevel="CRITICAL";this.state.analytics.cognitiveLoad=loadLevel;this.elements.cognitiveLoad.textContent=loadLevel;if(this.elements.cognitiveLoad)
this.elements.cognitiveLoad.style.color=loadLevel==="LOW"?"var(--primary-color)":loadLevel==="MEDIUM"?"var(--warning-color)":loadLevel==="HIGH"?"var(--warning-color)":"var(--danger-color)";this.updateBurnoutRisk(loadScore,taskCount);}
export function updateBurnoutRisk(loadScore,taskCount){const avgLoad=loadScore/Math.max(taskCount,1);const consistency=this.state.analytics.consistencyRate;const streak=this.state.scores.streak;let risk=0;risk+=avgLoad*25;risk+=(100-consistency)*0.3;risk+=Math.min(streak*2,20);risk=Math.min(risk,100);this.state.analytics.burnoutRisk=risk;if(this.elements.burnoutRisk){this.elements.burnoutRisk.style.width=`${risk}%`;this.elements.burnoutRisk.textContent=`${Math.round(risk)}%`;if(risk<30){this.elements.burnoutRisk.style.background="var(--primary-color)";}else if(risk<70){this.elements.burnoutRisk.style.background="var(--warning-color)";}else{this.elements.burnoutRisk.style.background="var(--danger-gradient)";}}}