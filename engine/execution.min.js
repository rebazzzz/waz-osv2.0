import{timeToMinutes,getDateKey,isSameDay}from"../utils/helpers.js";export function updateExecutionEngine(){const now=new Date();const dayOfWeek=this.state.selectedDate.getDay();const dateKey=getDateKey(this.state.selectedDate);let tasks=[...this.scheduleEngine.getScheduleForDate(this.state.selectedDate),];if(this.state.emergencyTasks[dateKey]){tasks=[...tasks,...this.state.emergencyTasks[dateKey]];}
tasks.sort((a,b)=>timeToMinutes(a.start)-timeToMinutes(b.start));this.updateCurrentTask(tasks,now);this.renderSchedule(tasks,now);this.updateScores();this.updateTimeHonesty(tasks);this.updatePsychology();this.updateDisciplineState();}
export function updateCurrentTask(tasks,now){const currentMinutes=now.getHours()*60+now.getMinutes();let currentTask=null;let nextTask=null;for(const task of tasks){const start=timeToMinutes(task.start);const end=timeToMinutes(task.end);if(currentMinutes>=start&&currentMinutes<=end){currentTask=task;break;}else if(currentMinutes<start&&!nextTask){nextTask=task;}}
if(currentTask){const timeLeft=timeToMinutes(currentTask.end)-currentMinutes;const hours=Math.floor(timeLeft/60);const minutes=timeLeft%60;const seconds=0;this.elements.currentTaskTime.textContent=`${currentTask.start} - ${currentTask.end}`;this.elements.currentTaskTitle.textContent=currentTask.title;this.elements.countdownTimer.textContent=`${hours
      .toString()
      .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
      .toString()
      .padStart(2, "0")}`;const dateKey=getDateKey(this.state.selectedDate);const isCompleted=this.state.completedTasks[dateKey]?.[currentTask.id];const isFailed=this.state.failedTasks[dateKey]?.[currentTask.id];if(!isCompleted&&!isFailed&&timeLeft<0){this.elements.currentTaskStatus.textContent="OVERDUE";if(this.elements.currentTaskStatus)
this.elements.currentTaskStatus.style.color="var(--warning-color)";if(this.elements.currentTaskContainer)
this.elements.currentTaskContainer.style.background="linear-gradient(135deg, var(--warning-color) 0%, rgba(255, 170, 0, 0.1) 100%)";this.autoFailTask(currentTask);}else if(isCompleted){this.elements.currentTaskStatus.textContent="COMPLETED";if(this.elements.currentTaskStatus)
this.elements.currentTaskStatus.style.color="var(--primary-color)";if(this.elements.currentTaskContainer)
this.elements.currentTaskContainer.style.background="linear-gradient(135deg, var(--primary-color) 0%, rgba(40, 167, 69, 0.1) 100%)";}else if(isFailed){this.elements.currentTaskStatus.textContent="FAILED";if(this.elements.currentTaskStatus)
this.elements.currentTaskStatus.style.color="var(--danger-color)";if(this.elements.currentTaskContainer)
this.elements.currentTaskContainer.style.background="linear-gradient(135deg, var(--danger-color) 0%, rgba(220, 53, 69, 0.1) 100%)";}else{this.elements.currentTaskStatus.textContent="IN PROGRESS";if(this.elements.currentTaskStatus)
this.elements.currentTaskStatus.style.color="var(--primary-color)";if(this.elements.currentTaskContainer)
this.elements.currentTaskContainer.style.background="linear-gradient(135deg, var(--primary-color) 0%, rgba(40, 167, 69, 0.1) 100%)";}
if(this.state.systemMode==="focus"||this.state.systemMode==="lockdown"){this.elements.focusTask.textContent=currentTask.title;this.elements.lockdownTask.textContent=currentTask.title;}}else if(nextTask){this.elements.currentTaskTime.textContent=`${nextTask.start} - ${nextTask.end}`;this.elements.currentTaskTitle.textContent=nextTask.title;this.elements.countdownTimer.textContent="--:--:--";this.elements.currentTaskStatus.textContent="UP NEXT";this.elements.currentTaskStatus.style.color="var(--text-secondary)";if(this.elements.currentTaskContainer)
this.elements.currentTaskContainer.style.background="linear-gradient(135deg, var(--primary-color) 0%, rgba(40, 167, 69, 0.1) 100%)";}else{this.elements.currentTaskTime.textContent="--:-- - --:--";this.elements.currentTaskTitle.textContent="No active task";this.elements.countdownTimer.textContent="--:--:--";this.elements.currentTaskStatus.textContent="AWAITING EXECUTION";this.elements.currentTaskStatus.style.color="var(--text-secondary)";if(this.elements.currentTaskContainer)
this.elements.currentTaskContainer.style.background="";}}
export function renderSchedule(tasks,now){const dateKey=getDateKey(this.state.selectedDate);const isToday=isSameDay(this.state.selectedDate,now);const currentMinutes=now.getHours()*60+now.getMinutes();let html="";tasks.forEach((task)=>{const start=timeToMinutes(task.start);const end=timeToMinutes(task.end);const duration=end-start;let progress=0;if(isToday&&currentMinutes>start&&currentMinutes<end){progress=((currentMinutes-start)/duration)*100;}else if(isToday&&currentMinutes>end){progress=100;}
const isCompleted=this.state.completedTasks[dateKey]?.[task.id];const isFailed=this.state.failedTasks[dateKey]?.[task.id];const isMissed=isToday&&currentMinutes>end&&!isCompleted&&!isFailed;const isActive=isToday&&currentMinutes>=start&&currentMinutes<=end&&!isCompleted&&!isFailed;const baseXP=task.baseXP||10;const difficulty=task.difficulty||1.0;const streakBonus=this.state.scores.streak*0.01;const totalXP=Math.round(baseXP*difficulty*(1+streakBonus)*this.state.scores.multiplier);let classes=["schedule-item"];if(isActive)classes.push("active");if(isCompleted)classes.push("completed");if(isFailed)classes.push("failed");if(isMissed)classes.push("missed");let statusText="";let xpColor="var(--primary-color)";let progressColor="var(--primary-color)";if(isCompleted){statusText="COMPLETED";}else if(isFailed){statusText="FAILED";xpColor="var(--danger-color)";progressColor="var(--danger-color)";}else if(isMissed){statusText="OVERDUE";xpColor="var(--warning-color)";progressColor="var(--warning-color)";}
html+=`
              <div class="${classes.join(" ")}" data-task-id="${task.id}">
                  <div class="item-header">
                      <div class="item-time">${task.start} - ${task.end}</div>
                      <div class="item-xp" style="color: ${xpColor}">${totalXP} XP</div>
                  </div>
                  <div class="item-title">${task.title}</div>
                  <div class="item-status">${statusText}</div>
                  <div class="item-progress">
                      <div class="progress-fill" style="width: ${progress}% ; background: ${progressColor}"></div>
                  </div>
              </div>
          `;});this.elements.scheduleGrid.innerHTML=html;document.querySelectorAll(".schedule-item").forEach((item)=>{item.addEventListener("click",(e)=>{const taskId=e.currentTarget.dataset.taskId;this.selectTask(taskId);});});}